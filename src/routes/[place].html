<svelte:head>
	<title>{metadata.title || params.place }</title>
	<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.css' rel='stylesheet'>

</svelte:head>

<div ref:map></div>

<style>
ref:map {
	position: absolute;
	top: 0;
	bottom: 0;
	width: 100%;
}
</style>

<script>
//import 'mapbox-gl/dist/mapbox-gl.css'
import * as topojson from 'topojson'

export default {

	preload({ params, query }) {
		const { place } = params;

		return this.fetch(`${place}/${place}.metadata.json`)
			.then(r => r.json())
			.then(metadata => ({ metadata }));
	},

	async oncreate() {
		let mapboxgl = await import('mapbox-gl');

		// TODO put this somewhere else
		mapboxgl.config.ACCESS_TOKEN = process.env.MAPBOX_ACCESS_TOKEN;

		// debugging
		if (process.env.NODE_ENV === 'development') {
			window.place = this;
			window.mapboxgl = mapboxgl;
			window.topojson = topojson;
		}

		const { metadata } = this.get();

		const map = this.map = new mapboxgl.Map({
			container: this.refs.map,
			style: 'mapbox://styles/mapbox/light-v9',
			bounds: metadata.bbox,
		});

		if (metadata.bbox) {
			map.fitBounds(metadata.bbox)
		}

		map.on('load', e => {

			map.addSource('places', {
				type: 'vector',
				url: `mapbox://${metadata.MAP_ID}`
			});

			map.addLayer({
				'id': 'places',
				type: 'fill',
				source: 'places',
				'source-layer': metadata.OBJECT_NAME,
				layout: {},
				paint: {
					'fill-color': '#ffff33',
					'fill-opacity': 0.2,
					'fill-outline-color': '#000',
				}
			});

			map.on('click', 'places', e => {
				console.log(e);
			});

			//map.getSource('place-boundaries').on('load', console.log);

		})
		
	}
}

</script>